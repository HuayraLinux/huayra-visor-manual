<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />

    <title>Index</title>

    <script type="text/javascript" charset="utf-8">
      var TOOLBAR = true;
      var http = require('http');

      var port = 33333;
      var url_home = "app://./documentacion/index.html";
      var gui = require('nw.gui');
      var ventana = gui.Window.get();
			
      window.doc = undefined;


      var server = http.createServer(function (req, res) {
        res.writeHead(200, {'Content-Type': 'text/plain'});
        res.end('Singleton webserver');
				console.log("Solititan la siguiente URL desde el webserver: " + req.url);
        mostrar_ventana(req.url);
      }).listen(port, '127.0.0.1', function(){
				// Cuando se inicia por primera vez.
				console.log("Iniciando la aplicacion por primera vez.");
        crear_menu();
      });


      //Error means another instance is running
      //So request the server to show previous instance
      server.on('error', function(){
        var url = 'http://127.0.0.1:' + port;
        var argumentos = gui.App.argv;

        if (argumentos) {
          var pagina = argumentos[0];
          url = url + "/" + pagina;
        }
				
				console.log("Iniciando la segunda sesión. Se cerrará la instancia usando la URL: " + url);

        http.get(url, function() {
          gui.App.quit();
        });
      });


      function crear_menu() {
        tray = new gui.Tray({title: '', icon: 'imagenes/tray.png' });

        menu = new gui.Menu();

        tray.on ('click',function() {
          mostrar_ventana();
        });

        menu.append(new gui.MenuItem({
          label: 'Mostrar',
          click: function() {
            mostrar_ventana();
          }
        }));

        menu.append(new gui.MenuItem({
          label: 'Salir',
          click: function() {
            gui.App.quit();
          }
        }));

        tray.menu = menu;
      }

      function mostrar_ventana(url) {
				
				if (url && url != '/undefined')
           url = "app://./documentacion" + url;
        else
           url = url_home;
				
				// TODO: evitar abrir mas de una pantalla al mismo tiempo.
				if (window.doc) {
					window.doc.restore();
					window.doc.show();
				} else {
        	window.doc = gui.Window.open(url, {toolbar: TOOLBAR});
				}

        window.doc.on("close", function() {
    			this.hide();
					window.doc = undefined;
        });

        window.doc.on('loaded', function() {
					window.doc.restore();
					window.doc.show();
					window.doc.focus();
					window.doc.requestAttention(true);
				});

      }
    </script>
  </head>

  <body>
    app.html
  </body>

</html>
