<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />

    <title>Index</title>

    <script type="text/javascript" charset="utf-8">

      var TOOLBAR = false;

      var http = require('http');

      var port = 33333; //some random port that is unlikely to be used by other apps
      var url_home = "app://./documentacion/index.html";
      var gui = require('nw.gui');
      var ventana = gui.Window.get();
      window.doc = undefined;

      crear_menu();

      //Try to create server
      var server = http.createServer(function (req, res) {
        res.writeHead(200, {'Content-Type': 'text/plain'});
        res.end('Prepros App');
        mostrar_ventana(req.url);
        //Show and maximize window on request
      }).listen(port, '127.0.0.1', function(){
        // ventana.window.location = url_home;
      });


      //Error means another instance is running
      //So request the server to show previous instance
      server.on('error', function(){
        var url = 'http://127.0.0.1:' + port;
        var argumentos = gui.App.argv;

        if (argumentos) {
          var pagina = argumentos[0];
          url = url + "/" + pagina;
        }

        http.get(url, function() {
          gui.App.quit();
        });
      });


      function crear_menu() {
        tray = new gui.Tray({title: '', icon: 'imagenes/tray.png' });

        menu = new gui.Menu();

        tray.on ('click',function() {
          mostrar_ventana();
        });

        menu.append(new gui.MenuItem({
          label: 'Mostrar',
          click: function() {
            mostrar_ventana();
          }
        }));

        menu.append(new gui.MenuItem({
          label: 'Salir',
          click: function() {
            gui.App.quit();
          }
        }));

        tray.menu = menu;
      }

      function mostrar_ventana(url) {

	if (url && url != '/undefined') {
           url = "app://./documentacion" + url;
        } else {
           url = url_home;
        }

	// TODO: evitar abrir mas de una pantalla al mismo tiempo.
        window.doc = gui.Window.open(url, {toolbar: TOOLBAR});

        window.doc.on("close", function() {
            this.hide();
        });

        window.doc.on('loaded', function() {
	   window.doc.restore();
	   window.doc.show();
	   window.doc.focus();
	   window.doc.requestAttention(true);
	});

      }
    </script>
  </head>

  <body>
    app.html
  </body>

</html>
